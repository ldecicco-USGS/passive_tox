---
title: "Explore Mixtures"
output: 
  bookdown::word_document2:
    fig_caption: yes
    toc: yes
editor_options: 
  chunk_output_type: console
---

```{r setup, echo=FALSE, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      fig.width = 7,
                      fig.height = 5)

library(tidyverse)
library(rpart)
library(party)
library(partykit)
library(rpartScore)
library(readxl)
library(flextable)
# library(subselect) #sim annealing
library(leaps) #regsubsets
library(glmnet)


source("R/mixtures/mix_script.R")
drake::loadd(chemicalSummary)

EARsum_endpoint <- sum_endpoints(chemicalSummary)

contributing_chems <- calc_contr_chems(EARsum_endpoint)

df_lu <- read_xlsx(path = file.path("data",
                                    "raw",
                                    "GLRItox_summary.xlsx"),
                           sheet = 1, skip=1) %>% 
    rename(site = STAID, 
           Basin_Area_mi2 = `Basin Area (mi2)`,
           Basin_area_km2 = `Basin Area (km2)`,
           Urban = `Urban (%)...6`, 
           Parking_lot = `Parking Lot (%)`,
           Agriculture = `Agriculture (%)...7`) %>% 
    mutate(Developed = Urban + Agriculture)

names(df_lu) <- gsub("\\s*\\([^\\)]+\\)",
                     replacement = "",
                     names(df_lu))
names(df_lu) <- gsub(pattern = "\\...",
                     replacement = "",
                     names(df_lu))
names(df_lu) <- gsub(pattern = ", ",
                     replacement = "_",
                     names(df_lu))
names(df_lu) <- gsub(pattern = "/",
                     replacement = "_",
                     names(df_lu))
names(df_lu) <- gsub(pattern = " ",
                     replacement = "_",
                     names(df_lu))
names(df_lu) <- gsub(pattern = "\\[",
                     replacement = "",
                     names(df_lu))
names(df_lu) <- gsub(pattern = "]",
                     replacement = "",
                     names(df_lu))
names(df_lu) <- gsub(pattern = "-",
                     replacement = "_",
                     names(df_lu))

not_all_na <- function(x) all(!is.na(x))

df_lu <- 
    df_lu %>% 
    select_if(not_all_na)

chm_key <- contributing_chems %>% 
    select(contr_chems) %>% 
    distinct() %>% 
    left_join(unique(select(contributing_chems,
                            contr_chems,
                            contr_chems_lt)), 
              by="contr_chems")

n_site_thresh <- 10

top_mixes <- contributing_chems %>% 
    group_by(contr_chems, endPoint) %>% 
    summarise(n_samples = n(),
              unique_sites = length(unique(site))) %>% 
    filter(unique_sites > {{n_site_thresh}}) %>% 
    arrange(desc(n_samples)) %>% 
    left_join(chm_key, by="contr_chems") %>% 
    mutate(contr_chems_st =
             paste(unique(unlist(contr_chems_lt)),
                   collapse = ","))

mix_graph_data <- data.frame()

for(i in 1:nrow(top_mixes)){
    
    chem <- top_mixes$contr_chems_lt[i]
    endpoint <- top_mixes$endPoint[i]
    
    mix_EAR_sum <- chemicalSummary %>%
        mutate(chnm = as.character(chnm)) %>% 
        filter(chnm %in% unlist(chem),
               endPoint == endpoint) %>% 
        group_by(site, date, endPoint, shortName) %>% 
        summarise(sumEAR = sum(EAR)) %>%
        mutate(mix_st = paste(unlist(chem),
                              collapse = ","),
               mix = list(unlist(chem)),
               mixID = i)
    
    if(length(unlist(chem)) == 1){
      mix_EAR_sum$mix_st <- paste0(mix_EAR_sum$mix_st,
                                   " (", mix_EAR_sum$mixID, ")")
    }
    
    mix_graph_data <- bind_rows(mix_graph_data,
                                mix_EAR_sum)
}

#Add a shifted term to try logs:
mix_graph_data$sumEAR_shifted <- mix_graph_data$sumEAR
mix_graph_data$sumEAR_shifted <- mix_graph_data$sumEAR_shifted + 0.5*min(mix_graph_data$sumEAR[mix_graph_data$sumEAR > 0], na.rm = TRUE) 

priority_endpoints <- top_mixes$endPoint

mixtures_in_ep <-
  chemicalSummary %>% 
  filter(endPoint %in% priority_endpoints) %>% 
  group_by(site, shortName, date, endPoint) %>%
  mutate(sum_ear_endpoint = sum(EAR)) %>%
  ungroup() %>%
  mutate(chem_mix_contribution = (EAR/sum_ear_endpoint)*100) %>% 
  filter(chem_mix_contribution > 1) %>% 
  group_by(site, shortName, date, endPoint, sum_ear_endpoint) %>%
  summarize(n_contr_chems = n(),
            contr_chems_lt = list(as.character(unique(chnm))),
            contr_cas_lt = list(as.character(unique(CAS))),
            contr_chems_st = paste(as.character(unique(chnm)),
                                collapse = ","),
            contr_chems = paste(as.character(unique(CAS)),
                                collapse = ","),
            max_individual_contr = max(EAR)) 

key <- mixtures_in_ep %>% 
              ungroup() %>%
              select(contr_chems,
                     contr_chems_st,
                     contr_chems_lt) 

key <- key[!duplicated(key$contr_chems), ]

top_mixes_per_ep <- mixtures_in_ep %>% 
  group_by(endPoint, contr_chems) %>% 
  summarize(n_sites = length(unique(site)),
            sumEAR = sum(sum_ear_endpoint)) %>% 
  filter(sumEAR == max(sumEAR)) %>% 
  ungroup() %>% 
  left_join(key,
            by="contr_chems")

# Mixtures to look at:
check_mix <- top_mixes %>% 
  ungroup() %>% 
  select(chemicals = contr_chems_st,
         chem_list = contr_chems_lt) %>% 
  bind_rows(select(top_mixes_per_ep, 
                   chemicals = contr_chems_st,
                   chem_list = contr_chems_lt))

if(all(c("Atrazine,DEET", "DEET,Atrazine") %in% check_mix$chemicals)){
  check_mix <- check_mix[check_mix$chemicals !=
                         "Atrazine,DEET", ]  
}

if(all(c("Benz(a)anthracene,Indeno(1,2,3-cd)pyrene",
         "Indeno(1,2,3-cd)pyrene,Benz(a)anthracene") %in% check_mix$chemicals)){
  
  check_mix <- check_mix[check_mix$chemicals !=                        "Indeno(1,2,3-cd)pyrene,Benz(a)anthracene", ]  
}

check_mix <- check_mix[!duplicated(check_mix$chemicals),]

```

# Overview

```{r regularBP, fig.cap="Urban hits"}
n_fun <- function(x){
  return(data.frame(y = 0,
                    label = length(x)))
}

mix_graph_data_lu <- mix_graph_data %>% 
    left_join(df_lu[,c("site","Urban","Agriculture")],
              by = "site") %>% 
    mutate(thresh = sumEAR > 0.001,
           facet = paste(mix_st, endPoint, sep = "\n"),
           mixture_id = as.integer(as.factor(facet)))

urban <- ggplot(data = mix_graph_data_lu,
                aes(x = thresh, y = Urban)) +
    geom_boxplot(outlier.shape = NA) +
    geom_jitter(color = "grey50", alpha = 0.4) +
    stat_summary(fun.data = n_fun,
                 geom = "text", hjust = 0.5) +
    facet_wrap(. ~ facet, ncol = 4) +
    theme_bw() +
    theme(strip.text = element_text(size = 8)) +
    xlab("EAR > 0.001")
urban

```


As you can see by Figure \@ref(fig:regularBP)

# Trees by Urban/Ag

```{r party2, results="asis"}

form <- formula("sumEAR ~ Urban + Agriculture + Urban^2 + Agriculture^2")

form2 <- formula("log10(sumEAR_shifted) ~ Urban + Agriculture + Urban^2 + Agriculture^2")

df_1 <- data.frame(chems_endpoint = character(),
                   tree_return = character(),
                   linear_return = character(),
                   log_return = character(),
                   stringsAsFactors = FALSE)

for(i in seq_len(nrow(top_mixes))){
    
  chem <- top_mixes$contr_chems_lt[i]
  endpoint <- top_mixes$endPoint[i]
  
  sub_df <- 
    mix_graph_data_lu %>% 
    filter(mixID == i) %>% 
    select(-mix)
    
  cat('\n##', unique(sub_df$mix_st), '\n')
  
  cat("\n### Tree\n")
  tree_return <- plot_trees(form, sub_df, endpoint)

  cat("\n")
  
  cat("\n### Linear\n")
  x_df <- plot_lm(form, sub_df)
  
  cat("\n")
  cat("\n### Log\n")
  x_df2 <- plot_lm(form2, sub_df,
                  sumEAR = "sumEAR_shifted", log=TRUE)
  cat("\n")
    
  df_1 <- bind_rows(df_1,
                    variable_summary(chem, endpoint,
                                     x_df, x_df2))
}

cat("\n## Summarize variables\n")

table_mix <- flextable(df_1)
table_mix <- width(table_mix, width = 1.5)
table_mix
cat("\n")

```

# Variable trimming

Variables available:

```{r table_of_categories}

df <- data.frame(a = c(names(df_lu)[2:11], NA),
                 b = names(df_lu)[12:22],
                 c = names(df_lu)[23:33],
                 stringsAsFactors = FALSE)

autofit(flextable(df))

```

Variables that have at least 1 site with at least 2 percent:

```{r corLU, results="asis"}
library(corrplot)

big_enough <- function(x, thresh = 2){
  max(x, na.rm = TRUE) > thresh
}

df_lu_filtered <- df_lu %>% 
  select(-site) %>% 
  select_if(big_enough)

M <- cor(df_lu_filtered)
corrplot(M, type="upper", tl.cex = 0.5)
```

Reduce the variables by those that have a corrolation coefficient >0.9 or <-0.9.

```{r corLU_reduced, results="asis"}
lu_vars <- colnames(M)
lu_vars_rev <- rev(lu_vars)

exclude <- c()
exclude_rev <- c()

for(i in seq_along(lu_vars)){
  
  check_var <- lu_vars[i]
  
  if(check_var %in% exclude){
    next
  } else {
    check_cor <- names(which(M[,check_var] > 0.9 | 
                        M[,check_var] < -0.9))
    check_cor <- check_cor[check_cor != check_var]
    exclude <- c(exclude, check_cor)
  }

}

# for(i in seq_along(lu_vars_rev)){
#   
#   check_var_rev <- lu_vars_rev[i]
#   
#   if(check_var_rev %in% exclude_rev){
#     next
#   } else {
#     check_cor <- names(which(M[,check_var_rev] > 0.95 | 
#                         M[,check_var_rev] < -0.95))
#     check_cor <- check_cor[check_cor != check_var_rev]
#     exclude_rev <- c(exclude_rev, check_cor)
#   }
# 
# }

df_lu_filtered <- df_lu_filtered[,-which(names(df_lu_filtered) %in% exclude)]

M2 <- cor(df_lu_filtered)
corrplot(M2, type="upper", tl.cex = 0.5)
```

The variables left by the 0.9 threshold:

```{r resultingVars, results="asis"}
df <- data.frame(a = names(df_lu_filtered)[1:7],
                 b = names(df_lu_filtered)[8:14],
                 c = names(df_lu_filtered)[15:21],
                 stringsAsFactors = FALSE)
cat("\n")
ft <- flextable(df)
ft <- delete_part(x = ft, part = "header")
autofit(ft)
cat("\n")
```

Now, we use the sites with detections and filter out variables that don't have a single site left that doesn't have 10% of that category.

```{r corLU_manual, results="asis"}

df_lu_filtered <- bind_cols(df_lu[,c("site","Urban","Crops")],
                            df_lu_filtered) %>% 
  select(-Basin_Area_mi2, -Population_Density)

key2 <- chemicalSummary %>% 
  select(chnm, Class) %>% 
  distinct() %>% 
  mutate(chnm = as.character(chnm),
         Class = as.character(Class))

check_mix$title <- NA
for(i in seq_len(nrow(check_mix))){
  chemicals <- unlist(check_mix$chem_list[i])
  class <- key2$Class[key2$chnm %in% unlist(chemicals)]
  check_mix$title[i] <- paste0(chemicals,":",class, collapse = "\n")
}

x <- data.frame(matrix(NA,
                  nrow = length(names(df_lu_filtered)), 
                  ncol = nrow(check_mix)))
names(x) <- check_mix$title

for(i in 1:ncol(x)){
  x[[i]] <- names(df_lu_filtered)
}
 
x <- x[-1,]

big_enough5 <- function(x, thresh = 10){
  max(x, na.rm = TRUE) > thresh
}

top_mixes$variables_to_use <- list(NA)
top_mixes_per_ep$variables_to_use <- list(NA)
# Get rid of variables with small influence:
for(i in 1:ncol(x)){
  
  chems <- unlist(check_mix$chem_list[i])
  
  sub_df <- chemicalSummary %>% 
    mutate(chnm = as.character(chnm)) %>% 
    filter(chnm %in% chems) %>%
    filter(EAR > 0) 
  
  sites <- unique(sub_df$site)
  
  sub_df_lu <- df_lu_filtered %>% 
    filter(site %in% sites) %>% 
    select(-site) %>% 
    select_if(big_enough5)
  
  x[!(x[[i]] %in% names(sub_df_lu)),i] <- ""
  
  index_tm <- sapply(top_mixes$contr_chems_lt, function(x){
    all(x %in% chems) 
  })
  
  index_tm_ep <- sapply(top_mixes_per_ep$contr_chems_lt, function(x){
    all(x %in% chems) 
  })
  
  top_mixes$variables_to_use[index_tm] <- list(x[[i]][x[[i]] != ""])
  top_mixes_per_ep$variables_to_use[index_tm_ep] <- list(x[[i]][x[[i]] != ""])
  
}

x <- x[rowSums(x == "") != ncol(x), ]

# data.table::fwrite(x, "table_of_landuse.csv")

```


Now we can think about individual categories to remove. For now...I'm taking out Basin Area, pulling Crops back in, and substituting Urban for Population Density.

```{r pickAndChoose, results="asis"}

fx <- flextable(x)
fx <- width(fx, width = 1.5)
fx

```


# Trees by more complicated land use options



```{r moreLandUse, results="asis"}

mix_graph_data_lu <- 
  mix_graph_data_lu %>%
  select(-mix) %>% 
  left_join(select(df_lu_filtered,
                   -Urban, -Agriculture),
            by="site")

for(i in seq_len(nrow(top_mixes))){
    
  mixture <- top_mixes$contr_chems_st[i]
  endpoint <- top_mixes$endPoint[i]
  
  variables_to_use <- top_mixes$variables_to_use[[i]]

  form_bigger <- formula(paste("sumEAR ~ ",
                               paste(variables_to_use,
                                     collapse = " + ")))
  form_bigger_log <- formula(paste("log10(sumEAR_shifted) ~ ",
                               paste(variables_to_use,
                                     collapse = " + ")))

  sub_df <- 
      mix_graph_data_lu %>% 
      filter(mixID == i) %>%
      distinct()
  
  cat('\n##', unique(sub_df$mix_st), '\n')
  
  cat("\n### Tree\n")
  tree_return <- plot_trees(form_bigger, sub_df, endpoint)
  cat("\n")

  new_form <- get_formula(sub_df, variables_to_use)

  
  cat("\n### Linear\n")
  x_df <- plot_lm(new_form, sub_df)
  cat("\n")
  
  cat("\n### Log\n")
  new_form2 <- get_formula(sub_df,
                           variables_to_use,
                           sumEAR = "sumEAR_shifted",
                           log=TRUE)
  
  x_df2 <- plot_lm(new_form2, sub_df,
                  sumEAR = "sumEAR_shifted", log=TRUE)
  
  df_temp <- variable_summary(chem, endpoint, x_df, x_df2)
    
  cat("\n")
  cat("\n### Summarize variables\n")
  cat("\n")
  table_mix <- flextable(df_temp)
  table_mix <- width(table_mix, width = 1.5)
  cat(knitr::knit_print(table_mix))
  cat("\n")

}



```


# All EARs for our top endpoints:

```{r allEARs, results ='asis'}

for(i in seq_len(nrow(top_mixes_per_ep))){
  
  ep <- top_mixes_per_ep$endPoint[i]
  chems <- top_mixes_per_ep$contr_chems_lt[[i]]
  
  cat('\n##', ep, '\n')

  cat('\n###', paste(chems, collapse = ", "), '\n')
  
  sub_df <- 
    chemicalSummary %>% 
    mutate(chnm = as.character(chnm)) %>% 
    filter(endPoint %in% ep,
           chnm %in% chems) %>% 
    group_by(site, date, shortName) %>% 
    summarise(sumEAR = sum(EAR),
              mix_st = paste(unique(chnm),
                             collapse = ",")) %>%
    ungroup() %>% 
    left_join(df_lu_filtered, by="site") %>% 
    select_if(not_all_na)
  
  if(length(unique(sub_df$site)) < 10){
    break
  }
  
  variables_to_use <- top_mixes_per_ep$variables_to_use[[i]]

  form_bigger <- formula(paste("sumEAR ~ ",
                           paste(variables_to_use,
                                 collapse = " + ")))
  
  cat("\n#### Tree\n")
  tree_return <- plot_trees(form_bigger, sub_df, ep)
  cat("\n")

  cat("\n#### Linear\n")
  cat("\n")
  
  new_form <- get_formula(sub_df, variables_to_use)
  
  if(is.null(new_form)){
    message("No linear")
    x_df <- data.frame()
  } else {
    x_df <- plot_lm(new_form, sub_df)
  }
  
  cat("\n")
  cat("\n#### Log\n")
  cat("\n")
  
  sub_df$sumEAR_shifted <- sub_df$sumEAR
  sub_df$sumEAR_shifted <- sub_df$sumEAR_shifted +
    0.5*min(sub_df$sumEAR_shifted[sub_df$sumEAR_shifted > 0],
            na.rm = TRUE)
  
  new_form_log <- get_formula(sub_df,
                              variables_to_use,
                              sumEAR = "sumEAR_shifted",
                              log = TRUE)
  if(is.null(new_form_log)){
    message("No log")
    x_df2 <- data.frame()
  } else {
    x_df2 <- plot_lm(new_form_log, sub_df,
              sumEAR = "sumEAR_shifted", log = TRUE)
  }

  cat("\n")
  
  df_temp <- variable_summary(chems, ep,
                              x_df, x_df2)
  
  cat("\n#### Summarize variables\n")
  cat("\n")
  table_mix <- flextable(df_temp)
  table_mix <- width(table_mix, width = 1.5)
  cat(knitr::knit_print(table_mix))
  cat("\n")

  
}


```

# Class Exploration

```{r classStuff}
class_sum <- chemicalSummary %>% 
  left_join(df_lu_filtered, by = "site")


graph_class <- class_sum %>% 
  group_by(Class, site, date, Urban, Agriculture) %>% 
  summarize(sumEAR = sum(EAR, na.rm = TRUE)) %>% 
  group_by(Class, site, Urban, Agriculture) %>% 
  summarise(maxSumEAR = max(sumEAR)) %>% 
  ungroup()


ggplot(data = graph_class) +
  geom_point(aes(x = Urban, y = maxSumEAR)) +
  facet_wrap(. ~ Class, nrow = 3, scale = "free_y") +
  theme_bw() +
  theme(axis.text = element_blank())

ggplot(data = graph_class) +
  geom_point(aes(x = Agriculture, y = maxSumEAR)) +
  facet_wrap(. ~ Class, nrow = 3, scale = "free_y") +
  theme_bw() +
  theme(axis.text = element_blank())

```


